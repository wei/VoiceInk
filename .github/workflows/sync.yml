name: Sync and Release

on:
  schedule:
    - cron: "0 9 * * *" # 4 AM ET (UTC-5)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.detect.outputs.new_tag }}
      release_name: ${{ steps.detect.outputs.release_name }}
      release_body: ${{ steps.detect.outputs.release_body }}
    steps:
      - name: Detect new upstream release
        id: detect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest upstream release tag
          LATEST=$(gh api repos/Beingpax/VoiceInk/releases/latest --jq '.tag_name' 2>/dev/null) || true
          if [ -z "$LATEST" ]; then
            echo "No upstream release found"
            exit 0
          fi
          echo "Upstream latest release: $LATEST"

          # Fork uses suffixed tags to avoid collision with upstream
          FORK_TAG="${LATEST}-wei"

          # Check if we already published this release in our fork
          EXISTS=$(gh release view "$FORK_TAG" --repo "${{ github.repository }}" --json tagName --jq '.tagName' 2>/dev/null) || true
          if [ -n "$EXISTS" ]; then
            echo "Release $FORK_TAG already exists in fork, nothing to do"
            exit 0
          fi

          echo "New release detected: $LATEST (fork tag: $FORK_TAG)"
          echo "new_tag=$FORK_TAG" >> "$GITHUB_OUTPUT"

          # Fetch release metadata
          gh api repos/Beingpax/VoiceInk/releases/latest --jq '.name // empty' > /tmp/release_name.txt
          gh api repos/Beingpax/VoiceInk/releases/latest --jq '.body // empty' > /tmp/release_body.txt

          echo "release_name=$(cat /tmp/release_name.txt)" >> "$GITHUB_OUTPUT"

          # Use a delimiter for multiline body
          echo "release_body<<RELEASE_EOF" >> "$GITHUB_OUTPUT"
          cat /tmp/release_body.txt >> "$GITHUB_OUTPUT"
          echo "RELEASE_EOF" >> "$GITHUB_OUTPUT"

  sync:
    needs: check
    if: needs.check.outputs.new_tag != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: auto
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Hard reset to upstream main
        run: |
          git remote add upstream https://github.com/Beingpax/VoiceInk.git
          git fetch upstream main --tags --force
          git reset --hard upstream/main

      - name: Cherry-pick CI commits
        run: |
          git fetch origin auto
          for sha in $(git log origin/auto --not upstream/main --reverse --format='%H' -- .github/workflows/); do
            git cherry-pick "$sha" || git cherry-pick --abort
          done

      - name: Force push
        run: git push --force origin HEAD:auto

  build:
    needs: [check, sync]
    if: needs.check.outputs.new_tag != ''
    runs-on: macos-15
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: auto

      - name: Select Xcode 26 (latest available)
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode_26*.app 2>/dev/null | sort -V | tail -1)
          if [ -z "$XCODE_PATH" ]; then
            echo "::error::No Xcode 26.x found on this runner"
            exit 1
          fi
          echo "Using: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"
          xcodebuild -version

      - name: Cache whisper.cpp XCFramework
        uses: actions/cache@v4
        id: whisper-cache
        with:
          path: ~/VoiceInk-Dependencies
          key: whisper-xcframework-macos-arm64-v1

      - name: Build VoiceInk (local/unsigned)
        run: make local

      - name: Verify build
        run: |
          file ~/Downloads/VoiceInk.app/Contents/MacOS/VoiceInk
          codesign -dv ~/Downloads/VoiceInk.app 2>&1 || true
          du -sh ~/Downloads/VoiceInk.app

      - name: Create distributable archive
        run: |
          cd ~/Downloads
          ditto -c -k --sequesterRsrc --keepParent VoiceInk.app VoiceInk-macOS-arm64.zip

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.check.outputs.new_tag }}"
          NAME="${{ needs.check.outputs.release_name }}"
          BODY=$(cat <<'RELEASE_EOF'
          ${{ needs.check.outputs.release_body }}
          RELEASE_EOF
          )

          gh release create "$TAG" \
            ~/Downloads/VoiceInk-macOS-arm64.zip \
            --repo "${{ github.repository }}" \
            --target auto \
            --title "${NAME:-$TAG}" \
            --notes "$BODY"
